<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡¶π‡¶ú ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Emoji Picker Script -->
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.2/index.js"></script>
    <style>
        /* Custom styling for chat bubble appearance */
        .chat-container {
            height: 100%;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding: 1rem;
        }
        .my-message {
            background-color: #DCF8C6; /* Light green/WhatsApp sender color */
            border-bottom-right-radius: 0;
        }
        .other-message {
            background-color: #FFFFFF; /* White/WhatsApp receiver color */
            border-bottom-left-radius: 0;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
        }
        #content-wrapper {
            flex-grow: 1;
            overflow: hidden; 
        }
        /* Style for the name setting modal/view */
        #name-setup-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f3f4f6;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Style the emoji picker container to float above the input */
        #emoji-picker-container {
            position: absolute;
            bottom: 65px; /* Adjust based on input area height */
            right: 15px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            overflow: hidden;
            display: none; /* Initially hidden */
        }
        emoji-picker {
            --background: #fff;
            --indicator-color: #10B981; /* Teal 500 */
            --border-color: #E5E7EB;
            --input-bg-color: #F3F4F6;
            width: 300px; /* Mobile friendly size */
            height: 350px;
        }
        @media (max-width: 640px) {
             emoji-picker {
                width: 100vw;
             }
             #emoji-picker-container {
                 bottom: 75px; /* Taller input on small screens */
                 right: 0;
                 left: 0;
             }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;
        
        // State variables for managing views and chats
        let currentView = 'setup'; // Initial state is 'setup' to set name
        let currentRecipientId = null;
        let currentRecipientName = null;
        let userDisplayName = null;
        let unsubscribeChat = null;
        let userStatusListener = null; // For listening to the recipient's status

        setLogLevel('debug'); 

        // HTML elements
        const appContainer = document.getElementById('app-container');
        const setupView = document.getElementById('name-setup-view');
        const displayNameInput = document.getElementById('display-name-input');
        const saveNameButton = document.getElementById('save-name-button');
        
        const chatView = document.getElementById('chat-view');
        const usersView = document.getElementById('users-view');
        const messagesEl = document.getElementById('messages');
        const userListContainer = document.getElementById('user-list-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusEl = document.getElementById('status');
        const userIdEl = document.getElementById('user-id-display');
        const tabGroupChat = document.getElementById('tab-group-chat');
        const tabUsers = document.getElementById('tab-users');
        const messageInputArea = document.getElementById('message-input-area');
        const backButton = document.getElementById('back-button');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        const chatHeaderSubTitle = document.getElementById('chat-header-subtitle');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPickerContainer = document.getElementById('emoji-picker-container');


        // --- Utility Functions ---

        /** Generates a consistent chat room ID for two users. */
        function getPrivateChatRoomId(id1, id2) {
            return id1 < id2 ? `${id1}_${id2}` : `${id2}_${id1}`;
        }
        
        /** Custom Modal replacement for alert() */
        function alertModal(message) {
            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4">
                        <p class="text-lg font-medium text-gray-800 mb-4">${message}</p>
                        <button id="modal-close-button" class="w-full bg-teal-500 text-white p-2 rounded-lg hover:bg-teal-600 transition">
                            ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-close-button').addEventListener('click', () => {
                modal.remove();
            });
        }

        /** Clears any active chat listener. */
        function stopListening() {
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            if (userStatusListener) {
                userStatusListener();
                userStatusListener = null;
                chatHeaderSubTitle.textContent = ''; // Clear status when leaving private chat
            }
        }

        // --- Core Functions ---

        // 1. Initialize Firebase and Authenticate User
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = `User ID: ${userId}`;
                        isAuthReady = true;

                        // Set up status listener before checking name
                        setupUserStatusUpdater(userId);

                        // Check if user has a display name set
                        await loadAndCheckUserName(userId);
                        
                        statusEl.textContent = '‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§';
                    } else {
                        statusEl.textContent = '‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Authentication failed:", error);
                statusEl.textContent = 'Initialization Error. Check console.';
            }
        }
        
        // 2. Set up real-time status updates for the current user
        function setupUserStatusUpdater(uid) {
            if (!db || !uid) return;
            const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/`, uid);

            // Function to update status in Firestore
            const updateStatus = async (isOnline) => {
                try {
                    await updateDoc(userDocRef, {
                        isOnline: isOnline,
                        lastSeen: serverTimestamp()
                    });
                } catch (e) {
                    console.warn("Could not update status (may happen before initial name registration):", e.code);
                }
            };

            // Set user online when the window is active
            window.addEventListener('focus', () => updateStatus(true));
            // Set user offline/last seen when closing or navigating away
            window.addEventListener('blur', () => updateStatus(false));
            // Set user offline when page is unloaded
            window.addEventListener('beforeunload', () => updateStatus(false)); 

            // Initial status update (will fail silently if name not set yet)
            updateStatus(true);
        }

        // 3. Load the user's display name from Firestore
        async function loadAndCheckUserName(uid) {
             const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/`, uid);
             const docSnap = await getDoc(userDocRef);
             
             if (docSnap.exists() && docSnap.data().displayName && docSnap.data().displayName !== uid.substring(0, 8) + '...') {
                 userDisplayName = docSnap.data().displayName;
                 // After loading name, go to main users list
                 switchView('users'); 
             } else {
                 // If no name found, show setup
                 switchView('setup');
             }
        }

        // 4. Register or update the user's display name
        async function registerUser(uid, name) {
             if (!db || !name) return;
             try {
                const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/`, uid);
                
                await setDoc(userDocRef, {
                    displayName: name,
                    lastSeen: serverTimestamp(),
                    isOnline: true // Set online upon registration
                }, { merge: true });
                
                userDisplayName = name;
                switchView('users'); // Move to main app view
             } catch (e) {
                 console.error("Error registering user:", e);
                 alertModal("‡¶®‡¶æ‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
             }
        }

        // 5. Switch between different views
        function switchView(view) {
            stopListening();
            messagesEl.innerHTML = '';
            currentView = view;
            emojiPickerContainer.style.display = 'none'; // Close picker on view change
            
            // Hide all content containers
            appContainer.classList.add('hidden');
            setupView.classList.add('hidden');
            chatView.classList.add('hidden');
            usersView.classList.add('hidden');
            messageInputArea.classList.add('hidden');
            backButton.classList.add('hidden');
            chatHeaderSubTitle.textContent = ''; // Clear status subtitle
            
            // Reset tabs style
            tabGroupChat.classList.remove('bg-teal-700', 'font-bold');
            tabUsers.classList.remove('bg-teal-700', 'font-bold');
            tabGroupChat.classList.add('bg-teal-600');
            tabUsers.classList.add('bg-teal-600');
            
            // Handle view changes
            if (view === 'setup') {
                setupView.classList.remove('hidden');
                return;
            }
            
            // If not setup, show the main app container
            appContainer.classList.remove('hidden');
            chatHeaderTitle.textContent = 'üí¨ ‡¶∏‡¶π‡¶ú ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™'; 

            if (view === 'group-chat') {
                currentRecipientId = null;
                chatView.classList.remove('hidden');
                messageInputArea.classList.remove('hidden');
                tabGroupChat.classList.add('bg-teal-700', 'font-bold');
                tabGroupChat.classList.remove('bg-teal-600');
                listenForGroupMessages();
            } else if (view === 'users') {
                currentRecipientId = null;
                usersView.classList.remove('hidden');
                tabUsers.classList.add('bg-teal-700', 'font-bold');
                tabUsers.classList.remove('bg-teal-600');
                fetchAndDisplayUsers();
            } else if (view === 'private-chat') {
                chatView.classList.remove('hidden');
                messageInputArea.classList.remove('hidden');
                backButton.classList.remove('hidden');
                chatHeaderTitle.textContent = currentRecipientName;
                listenForPrivateMessages(currentRecipientId);
                listenForRecipientStatus(currentRecipientId);
            }
        }

        // 6. Handle Private Chat initialization
        function openPrivateChat(recipientId, recipientName) {
            currentRecipientId = recipientId;
            currentRecipientName = recipientName;
            switchView('private-chat');
        }

        // 7. Listen for a single recipient's online status
        function listenForRecipientStatus(recipientId) {
             if (!db || !recipientId) return;
             
             const recipientDocRef = doc(db, `/artifacts/${appId}/public/data/users/`, recipientId);

             userStatusListener = onSnapshot(recipientDocRef, (docSnap) => {
                 if (docSnap.exists()) {
                     const data = docSnap.data();
                     let statusText = '';
                     
                     if (data.isOnline) {
                         statusText = '<span class="text-xs font-medium text-white">Online Now</span>';
                     } else if (data.lastSeen && data.lastSeen.toDate) {
                         const date = data.lastSeen.toDate();
                         const timeString = date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
                         statusText = `<span class="text-[10px] text-gray-200">Last seen: ${timeString}</span>`;
                     }
                     chatHeaderSubTitle.innerHTML = statusText;
                 }
             }, (error) => {
                 console.error("Error fetching recipient status:", error);
                 chatHeaderSubTitle.textContent = '';
             });
        }


        // 8. Fetch and display all registered users
        function fetchAndDisplayUsers() {
            if (!db || !isAuthReady) return;

            const usersCollectionPath = `/artifacts/${appId}/public/data/users`;
            // Order by lastSeen to show active users first
            const q = query(collection(db, usersCollectionPath), orderBy('lastSeen', 'desc'));

            onSnapshot(q, (snapshot) => {
                let usersHtml = '<p class="p-4 text-gray-500 text-sm">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ:</p>';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const userUid = doc.id;
                    const isCurrentUser = userUid === userId;
                    
                    if (isCurrentUser) return;

                    let lastSeenText = 'Offline';
                    let statusColor = 'text-gray-500';

                    if (data.isOnline) {
                         lastSeenText = 'Online Now';
                         statusColor = 'text-green-600 font-semibold';
                    } else if (data.lastSeen && data.lastSeen.toDate) {
                         const date = data.lastSeen.toDate();
                         // Format last seen time: HH:MM AM/PM
                         lastSeenText = 'Last seen: ' + date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
                    }

                    usersHtml += `
                        <div data-user-id="${userUid}" data-user-name="${data.displayName}" 
                             class="flex items-center p-3 border-b border-gray-200 bg-white hover:bg-gray-50 cursor-pointer transition duration-150 rounded-lg mx-2 mb-1 shadow-sm">
                            <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold text-lg mr-3">
                                ${data.displayName[0]}
                            </div>
                            <div class="flex-grow">
                                <p class="text-sm font-semibold text-gray-800">${data.displayName}</p>
                                <p class="text-xs ${statusColor}">${lastSeenText}</p>
                            </div>
                            <button class="text-teal-500 text-sm font-medium hover:text-teal-600">
                                ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®
                            </button>
                        </div>
                    `;
                });
                
                if (snapshot.size <= 1) {
                     usersHtml += '<p class="text-center text-gray-500 mt-4 text-sm">‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
                }
                
                userListContainer.innerHTML = usersHtml;
                
                userListContainer.querySelectorAll('[data-user-id]').forEach(el => {
                    el.addEventListener('click', () => {
                        const recipientId = el.getAttribute('data-user-id');
                        const recipientName = el.getAttribute('data-user-name');
                        openPrivateChat(recipientId, recipientName);
                    });
                });
                
            }, (error) => {
                console.error("Error fetching user list:", error);
            });
        }

        // 9. Generic Message Renderer
        function renderMessages(snapshot) {
            let messagesHtml = '';
            const isGroupChat = currentView === 'group-chat';

            snapshot.forEach((doc) => {
                const data = doc.data();
                const isMyMessage = data.userId === userId;
                const messageClass = isMyMessage ? 'self-end my-message' : 'self-start other-message';
                const senderDisplayName = data.displayName || data.userId.substring(0, 8) + '...';

                // Format timestamp
                let timeString = '';
                if (data.timestamp && data.timestamp.toDate) {
                    const date = data.timestamp.toDate();
                    // Accurate time format: HH:MM AM/PM
                    timeString = date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
                }

                messagesHtml += `
                    <div class="flex flex-col mb-4 max-w-[80%] ${isMyMessage ? 'ml-auto' : 'mr-auto'}">
                        <div class="p-3 rounded-xl shadow-md text-gray-800 ${messageClass} min-w-[120px] break-words">
                            ${isGroupChat && !isMyMessage ? `<div class="text-[10px] text-teal-700 font-bold mb-1">${senderDisplayName}</div>` : ''}
                            <p class="text-sm font-medium mb-1">
