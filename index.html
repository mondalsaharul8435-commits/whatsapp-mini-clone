<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp-স্টাইল চ্যাট অ্যাপ</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Emoji Picker Script -->
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.2/index.js"></script>
    <style>
        /* Custom styling for chat bubble appearance */
        .chat-container {
            height: 100%;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding: 1rem;
            /* Added chat background image for WhatsApp feel */
            background-image: url('https://placehold.co/600x600/E8E8E8/E8E8E8?text='); 
            background-size: cover;
        }
        .my-message {
            background-color: #DCF8C6; /* Light green/WhatsApp sender color */
            border-bottom-right-radius: 0;
        }
        .other-message {
            background-color: #FFFFFF; /* White/WhatsApp receiver color */
            border-bottom-left-radius: 0;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
        }
        #content-wrapper {
            flex-grow: 1;
            overflow: hidden; 
        }
        /* Style for the name setting modal/view */
        .full-screen-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f3f4f6;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Style the emoji picker container to float above the input */
        #emoji-picker-container {
            position: absolute;
            bottom: 65px; 
            right: 15px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            overflow: hidden;
            display: none; /* Initially hidden */
        }
        emoji-picker {
            --background: #fff;
            --indicator-color: #075E54; /* WhatsApp Teal */
            --border-color: #E5E7EB;
            --input-bg-color: #F3F4F6;
            width: 300px; /* Mobile friendly size */
            height: 350px;
        }
        @media (max-width: 640px) {
             emoji-picker {
                width: 100vw;
             }
             #emoji-picker-container {
                 bottom: 75px; 
                 right: 0;
                 left: 0;
             }
        }
        /* Style for the chat header (WhatsApp Green) */
        #chat-app-header {
            background-color: #075E54; /* WhatsApp Green */
        }
        /* Style for chat header title font */
        #chat-header-title {
            color: #ffffff;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // SIMULATED OTP: Use this fixed PIN for verification
        const SIMULATED_OTP = '1234'; 

        let db, auth, userId = null;
        let isAuthReady = false;
        
        // State variables for managing views and chats
        let currentView = 'setup'; 
        let currentRecipientId = null;
        let currentRecipientName = null;
        let userDisplayName = null;
        let userPhoneNumber = null;
        let unsubscribeChat = null;
        let userStatusListener = null; 
        
        // Temporary state for registration process
        let tempDisplayName = null;
        let tempPhoneNumber = null;

        setLogLevel('debug'); 

        // HTML elements
        const appContainer = document.getElementById('app-container');
        const setupView = document.getElementById('name-setup-view');
        const otpView = document.getElementById('otp-verification-view'); // New OTP view
        const displayNameInput = document.getElementById('display-name-input');
        const phoneNumberInput = document.getElementById('phone-number-input'); 
        const continueButton = document.getElementById('continue-button'); // Button to send 'OTP'
        
        const otpInput = document.getElementById('otp-input');
        const verifyOtpButton = document.getElementById('verify-otp-button');
        const otpPhoneDisplay = document.getElementById('otp-phone-display');
        
        const chatView = document.getElementById('chat-view');
        const usersView = document.getElementById('users-view');
        const messagesEl = document.getElementById('messages');
        const userListContainer = document.getElementById('user-list-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userIdEl = document.getElementById('user-id-display');
        const messageInputArea = document.getElementById('message-input-area');
        const backButton = document.getElementById('back-button');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        const chatHeaderSubTitle = document.getElementById('chat-header-subtitle');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPickerContainer = document.getElementById('emoji-picker-container');
        const chatAppHeader = document.getElementById('chat-app-header');


        // --- Utility Functions ---

        /** Generates a consistent chat room ID for two users. */
        function getPrivateChatRoomId(id1, id2) {
            return id1 < id2 ? `${id1}_${id2}` : `${id2}_${id1}`;
        }
        
        /** Custom Modal replacement for alert() */
        function alertModal(message) {
            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4">
                        <p class="text-lg font-medium text-gray-800 mb-4">${message}</p>
                        <button id="modal-close-button" class="w-full p-2 bg-green-700 text-white rounded-lg hover:bg-green-800 transition">
                            বন্ধ করুন
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-close-button').addEventListener('click', () => {
                modal.remove();
            });
        }
        
        /** Formats timestamp to 'HH:MM AM/PM' */
        function formatTime(timestamp) {
            if (timestamp && timestamp.toDate) {
                const date = timestamp.toDate();
                return date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
            }
            return '';
        }

        /** Clears any active chat listener. */
        function stopListening() {
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            if (userStatusListener) {
                userStatusListener();
                userStatusListener = null;
                chatHeaderSubTitle.textContent = ''; 
            }
        }

        // --- Core Functions ---

        // 1. Initialize Firebase and Authenticate User
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = `Internal User ID: ${userId}`;
                        isAuthReady = true;

                        setupUserStatusUpdater(userId);
                        await loadAndCheckUserName(userId);
                        
                    } else {
                        // Not used in this simplified auth flow, but good practice
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Authentication failed:", error);
                alertModal('Firebase Initialization Error. Check console.');
            }
        }
        
        // 2. Set up real-time status updates for the current user
        function setupUserStatusUpdater(uid) {
            if (!db || !uid) return;
            const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/`, uid);

            const updateStatus = async (isOnline) => {
                try {
                    if (userDisplayName && userPhoneNumber) {
                         await updateDoc(userDocRef, {
                            isOnline: isOnline,
                            lastSeen: serverTimestamp()
                        });
                    }
                } catch (e) {
                    console.warn("Could not update status (may happen before initial registration):", e.code);
                }
            };

            window.addEventListener('focus', () => updateStatus(true));
            window.addEventListener('blur', () => updateStatus(false));
            window.addEventListener('beforeunload', () => updateStatus(false)); 

            updateStatus(true);
        }

        // 3. Load the user's display name and number from Firestore
        async function loadAndCheckUserName(uid) {
             const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/`, uid);
             const docSnap = await getDoc(userDocRef);
             
             if (docSnap.exists() && docSnap.data().displayName && docSnap.data().phoneNumber) {
                 const data = docSnap.data();
                 userDisplayName = data.displayName;
                 userPhoneNumber = data.phoneNumber;
                 switchView('users'); 
             } else {
                 switchView('setup');
             }
        }

        // 4. Final step: Register the user after successful OTP verification
        async function completeRegistration() {
             const name = tempDisplayName;
             const phone = tempPhoneNumber;
             
             if (!db || !userId || !name || !phone) {
                 alertModal("রেজিস্ট্রেশন ডেটা খুঁজে পাওয়া যায়নি। আবার চেষ্টা করুন।");
                 switchView('setup');
                 return;
             }
             
             try {
                const userDocRef = doc(db, `/artifacts/${appId}/public/data/users/`, userId);
                
                await setDoc(userDocRef, {
                    displayName: name,
                    phoneNumber: phone,
                    lastSeen: serverTimestamp(),
                    isOnline: true 
                }, { merge: true });
                
                userDisplayName = name;
                userPhoneNumber = phone;
                tempDisplayName = null;
                tempPhoneNumber = null;
                switchView('users'); 
             } catch (e) {
                 console.error("Error registering user:", e);
                 alertModal("নাম ও নম্বর সেভ করতে সমস্যা হয়েছে।");
             }
        }

        // 5. Switch between different views
        function switchView(view) {
            stopListening();
            messagesEl.innerHTML = '';
            currentView = view;
            emojiPickerContainer.style.display = 'none'; 
            
            // Hide all content containers
            appContainer.classList.add('hidden');
            setupView.classList.add('hidden');
            otpView.classList.add('hidden');
            chatView.classList.add('hidden');
            usersView.classList.add('hidden');
            messageInputArea.classList.add('hidden');
            backButton.classList.add('hidden');
            chatHeaderSubTitle.textContent = ''; 
            chatAppHeader.classList.add('hidden'); 
            
            // Handle view changes
            if (view === 'setup') {
                setupView.classList.remove('hidden');
                displayNameInput.value = tempDisplayName || '';
                phoneNumberInput.value = tempPhoneNumber || '';
                return;
            }
            if (view === 'otp') {
                otpView.classList.remove('hidden');
                otpInput.value = '';
                otpPhoneDisplay.textContent = `(+88) ${tempPhoneNumber}`;
                alertModal(`সিমুলেটেড OTP হলো: ${SIMULATED_OTP}. এই পিনটি ব্যবহার করুন।`);
                return;
            }
            
            // If not setup/otp, show the main app container and header
            appContainer.classList.remove('hidden');
            chatAppHeader.classList.remove('hidden');
            
            if (view === 'users') {
                 chatHeaderTitle.textContent = 'চ্যাট তালিকা'; 
                 document.getElementById('recipient-info').classList.add('hidden');
                 usersView.classList.remove('hidden');
                 fetchAndDisplayUsers();
            } else if (view === 'private-chat') {
                document.getElementById('recipient-info').classList.remove('hidden');
                chatView.classList.remove('hidden');
                messageInputArea.classList.remove('hidden');
                backButton.classList.remove('hidden');
                chatHeaderTitle.textContent = currentRecipientName;
                listenForPrivateMessages(currentRecipientId);
                listenForRecipientStatus(currentRecipientId);
            }
        }

        // 6. Handle OTP Step: Store temp data and move to OTP screen
        function handleOtpRequest() {
            const name = displayNameInput.value.trim();
            const phone = phoneNumberInput.value.trim();
            
            if (name.length < 2) {
                alertModal("নামটি কমপক্ষে দুটি অক্ষরের হতে হবে।");
                return;
            }
            if (!/^\d{8,15}$/.test(phone)) {
                 alertModal("অনুগ্রহ করে একটি বৈধ ফোন নম্বর দিন (যেমন: 017xxxxxx, কোনো প্রতীক ছাড়া)।");
                 return;
            }
            
            tempDisplayName = name;
            tempPhoneNumber = phone;
            switchView('otp');
        }

        // 7. Handle Private Chat initialization
        function openPrivateChat(recipientId, recipientName) {
            currentRecipientId = recipientId;
            currentRecipientName = recipientName;
            switchView('private-chat');
        }

        // 8. Listen for a single recipient's online status
        function listenForRecipientStatus(recipientId) {
             if (!db || !recipientId) return;
             
             const recipientDocRef = doc(db, `/artifacts/${appId}/public/data/users/`, recipientId);

             userStatusListener = onSnapshot(recipientDocRef, (docSnap) => {
                 if (docSnap.exists()) {
                     const data = docSnap.data();
                     let statusText = '';
                     
                     if (data.isOnline) {
                         statusText = 'Online Now';
                     } else if (data.lastSeen && data.lastSeen.toDate) {
                         statusText = `Last seen: ${formatTime(data.lastSeen)}`;
                     }
                     chatHeaderSubTitle.textContent = statusText;
                 }
             }, (error) => {
                 console.error("Error fetching recipient status:", error);
                 chatHeaderSubTitle.textContent = '';
             });
        }


        // 9. Fetch and display all registered users
        function fetchAndDisplayUsers() {
            if (!db || !isAuthReady) return;

            const usersCollectionPath = `/artifacts/${appId}/public/data/users`;
            const q = query(collection(db, usersCollectionPath), orderBy('lastSeen', 'desc'));

            onSnapshot(q, (snapshot) => {
                let usersHtml = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const userUid = doc.id;
                    const isCurrentUser = userUid === userId;
                    
                    if (isCurrentUser) return;

                    let lastSeenText = 'Offline';
                    let statusColor = 'text-gray-500';

                    if (data.isOnline) {
                         lastSeenText = 'Online Now';
                         statusColor = 'text-green-500 font-semibold';
                    } else if (data.lastSeen && data.lastSeen.toDate) {
                         lastSeenText = 'Last seen: ' + formatTime(data.lastSeen);
                    }

                    usersHtml += `
                        <div data-user-id="${userUid}" data-user-name="${data.displayName}" 
                             class="flex items-center p-3 border-b border-gray-200 bg-white hover:bg-gray-50 cursor-pointer transition duration-150">
                            <!-- User Avatar -->
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg mr-4" style="background-color: ${stringToColor(data.displayName)}">
                                ${data.displayName[0].toUpperCase()}
                            </div>
                            <!-- User Info -->
                            <div class="flex-grow">
                                <p class="text-base font-semibold text-gray-800">${data.displayName}</p>
                                <p class="text-xs ${statusColor} italic">${lastSeenText}</p>
                            </div>
                            <!-- Phone Number -->
                            <div class="text-xs text-gray-500">
                                ${data.phoneNumber}
                            </div>
                        </div>
                    `;
                });
                
                if (snapshot.size <= 1) {
                     usersHtml = '<p class="text-center text-gray-500 mt-10 p-4 text-sm">চ্যাট তালিকায় কোনো বন্ধু নেই। অন্য একটি ডিভাইসে অ্যাপটি খুলে লগইন করুন।</p>';
                }
                
                userListContainer.innerHTML = usersHtml;
                
                userListContainer.querySelectorAll('[data-user-id]').forEach(el => {
                    el.addEventListener('click', () => {
                        const recipientId = el.getAttribute('data-user-id');
                        const recipientName = el.getAttribute('data-user-name');
                        openPrivateChat(recipientId, recipientName);
                    });
                });
                
            }, (error) => {
                console.error("Error fetching user
